{% if plugin_old_version.stdout | default("") != "" %}
DROP PLUGIN IF EXISTS {{ manifest.name }} {{ plugin_old_version.stdout }};
{% endif %}
{% if plugin_current_version.stdout | default("") != "" %}
ALTER PLUGIN {{ manifest.name }} {{ plugin_current_version.stdout }} DISABLE;
{% endif %}
CREATE PLUGIN IF NOT EXISTS "{{ manifest.name }}" {{ manifest.version }} OPTION (TIMEOUT = {{ plugin.value.plugin_timeout | default(300) }});

{% if plugin.value.migration_context is defined %}
{% for param, val in plugin.value.migration_context.items() %}
ALTER PLUGIN "{{ manifest.name }}" {{ manifest.version }} SET migration_context."{{ param }}" = '{{ val }}' OPTION (TIMEOUT = {{ plugin.value.plugin_timeout | default(300) }});
{% endfor %}
{% endif %}

ALTER PLUGIN "{{ manifest.name }}" MIGRATE TO {{ manifest.version }} OPTION (TIMEOUT = {{ plugin.value.migration_timeout | default(300) }});

{% for servicename in services %}
{% set ns = namespace(service_tiers=['default']) %}
{% if plugin.value.services is defined %}
{% for sname, serviceconf in plugin.value.services.items() if sname == servicename %}
{% set ns.service_tiers = serviceconf.tiers %}
{% endfor %}
{% endif %}
{% for service_tier in ns.service_tiers %}
ALTER PLUGIN "{{ manifest.name }}" {{ manifest.version }} ADD SERVICE "{{ servicename }}" TO TIER "{{ service_tier }}" OPTION (TIMEOUT = {{ plugin.value.plugin_timeout | default(300) }});
{% endfor %}
{% endfor %}

{% if (plugin_enable | bool ) == true %}
ALTER PLUGIN "{{ manifest.name }}" {{ manifest.version }} ENABLE OPTION (TIMEOUT = {{ plugin.value.plugin_timeout | default(300) }});
{% endif %}

