---
# tasks for remove cluster

- name: Set server failure domain
  ansible.builtin.set_fact:
    host_group: "none"
  when: host_group is undefined

- name: Generate list of instances per server
  ansible.builtin.import_tasks:
    file: genin.yml

- name: Remove systemd unit files
  ansible.builtin.service:
    name: '{{ cluster_id }}@{{ instance }}.service'
    enabled: false
    state: stopped
  loop: '{{ instances_on_host }}'
  loop_control:
    loop_var: instance

- name: Remove systemd env dirs
  ansible.builtin.file:
    name: '{{ systemd_dir }}/{{ cluster_id }}@{{ instance }}.service.d'
    state: absent
  loop: '{{ instances_on_host }}'
  loop_control:
    loop_var: instance

- name: Remove systemd template file
  ansible.builtin.file:
    name: '{{ systemd_dir }}/{{ cluster_id }}@.service'
    state: absent

- name: Remove dirs if set purge variable
  ansible.builtin.file:
    name: '{{ item }}'
    state: absent
  loop:
    - '{{ conf_dir }}/{{ cluster_id }}'
    - '{{ data_dir }}/{{ cluster_id }}'
    - '{{ run_dir }}/{{ cluster_id }}'
    - '{{ log_dir }}/{{ cluster_id }}'
  when: purge
