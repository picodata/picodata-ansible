# Инсталлация кластреа на серверах с разграничением полномочий

В крупных организациях роли системного администратора и администратора БД разделены с целью обеспечения информационной безопасности.
В этом случае роль позволяет выполнить первоначальную настройку серверов с учетной записью системного администратора и последующую инсталляцию кластера администратором БД.

> **Внимание!** Это возможно только при использовании `supervisord`!

> Независимо от варианта инсталляции кластера процессы инстансов на серверах могут быть запущены под сервисной учетной записью (см. параметры `user` и `group`)

## Требования для установки кластера

> Для удобства администрирования кластера корневые каталоги желательно (но не обязатально) располагать в отдельном разделе (/opt или /data).

На серверах:
- должна присутствовать утилита `setfacl` (обычно находится в пакете `acl`)
- установлен пакет `supervisor`
- созданы учетные записи для системного администратора, администратора БД и, при необходимости, пользователя, указанного в параметре `user`
- установлен пакет `picodata` необходимой версии

В инвентарном файле необходимо:
- при необходимости определить каталоги: `conf_dir`, `data_dir`, `run_dir`, `log_dir`, `supervisord_dir`
- выставить значение переменной `rootless` в `true`
- выставить значение переменной `init_system` в `supervisord`
- если планируется запускать процессы picodata под пользователем, отличным от root, то имя этого пользователя (переменная `user`) должно совпадать с учетной записью администратора БД  это техническое ограничение на данный момент

## Первоначальная настройка серверов

Выполняется под учетной записью системного администратора, например `sysadm`, 
у данной учетной записи должна быть возможность повышения привилегий через sudo.

Первоначальная настройка серверов состоит из шагов:
- при необходимости (при отсутствии на серверах пакета `picodata`) подключается репозиторий Пикодаты и из него устанавливается пакет picodata последней доступной версии
- создаются каталоги для работы picodata
- создается systemd служба для supervisord
- при размещении логов в файлах, создается logrotate-файл для их подрезки

Подготовка серверов кластера выполняется командой:
```bash
ansible-playbook -i <inventory> run.yml -t deploy_become -e 'ansible_user=sysadm' -e 'ansible_password=<verysecret>'
```

Переменные `ansible_user` и `ansible_password` можно вынести в переменные окружения, либо в ansible.cfg, в таком случае указывать их при запуске команды будет не нужно. 
Как это сделать описано в документации Anibsle: https://docs.ansible.com/ansible/latest/reference_appendices/config.html

## Инсталляция кластера

Выполняется под учетной записью администратора БД, например `dbadm`.

Установка кластера выполняется командой:
```bash
ansible-playbook -i <inventory> run.yml -e 'ansible_user=dbadm' -e 'ansible_password=<verysecret>'
```

При этом задачи, требующие повышенных привилегий будут пропущены.

> Переменные `ansible_user` и `ansible_password` лучше указать в инвентарном файле. Наша рекомендация - использовать доступ к серверам по ssh-ключу вместо пароля.

## Удаление кластера

Удаление кластаре выполняется в обратном порядке: сначала под учетной записью администратора БД останавливаем кластер и удаляем данные, затем, при необходимости, под системным администратором удаляем системные файлы и каталоги.

> Подразумевается, что переменная `ansible_user` прописана в инвентарном файле.

Удаление кластера выполняется командой:
```bash
ansible-playbook -i <inventory> run.yml -t remove'
```

Полное удаление кластера выполняется командой:
```bash
ansible-playbook -i <inventory> run.yml -t remove -e purge=true'
```

При этом будут удалены файлы с данными, лог-журналы и конфигурационные файлы.

## Полное удаление кластера с серверов

Выполняется под учетной записью администратора БД, например `sysadm`.

Удаление кластера выполняется командой:
```bash
ansible-playbook -i <inventory> run.yml -t remove_become -e 'ansible_user=sysadm' -e 'ansible_password=<verysecret>'
```

При этом будет остановлена и удалена systemd-служба запуска supervisord, удалены все корневые каталоги, которые были созданы для кластера.