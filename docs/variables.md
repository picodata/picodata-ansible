# Переменные, используемые в роли

## Переменные, общие на весь кластер

### Инсталляция
| Имя | Значение по умолчанию | Описание |
| ---      | ---      | ---      |
| admin_password | | пароль для учетной записи admin, который должен удовлетворять [условиям](https://docs.picodata.io/picodata/24.4/tutorial/access_control/#allowed_passwords) |
| auth_webui | true | авторизация в WebUI, работает с Пикодатой версии 25.4.2 и выше, если версия меньше, то не выставляйте эту переменную |
| autonames | true | деплой кластера с автогенерацией имен инстансов |
| cluster_name | demo | имя кластера |
| db_config | | словарь с [параметрами конфигурации кластера](https://docs.picodata.io/picodata/stable/reference/db_config/) |
| default_bucket_count | 30000 | количество бакетов в каждом тире по умолчанию |
| init_system | systsemd | система управления сервисами и процессами (systemd, supervisord)  |
| install_packages | true | необходимость установки picodata из репозитория пакетов |
| iptoro_ca_file | | файл с доверенным центром сертификации для настройки mTLS внутри кластера |
| iptoro_cert_file | | файл с сертификатом сервера для настройки mTLS внутри кластера |
| iptoro_key_file | | файл с закрытым ключом сервера для настройки mTLS внутри кластера |
| iproto_tls | false | признак использования mTLS внутри кластера |
| group | root | имя группы для файлов (эта группа уже должна быть создана на каждом сервере кластера) |
| package_with_version | | имя пакета picodata с нужной версией для установки из репозитория. Пример для ubuntu focal: `package_with_version: 'picodata=25.3.1.0-focal'` |
| picodata_package_path | | путь до пакета Picodata, который нужно установить на серверах |
| pg_ca_file | | файл с доверенным центром сертификации для ssl-соединения в pgproto |
| pg_cert_file | | файл с сертификатом сервера для ssl-соединения в pgproto |
| pg_key_file | | файл с закрытым ключом сервера для ssl-соединения в pgproto |
| pg_port_delay | 5 | задеркжа между проверками доступности порта postgress-протокола в сек (если кластер большой, то стоит увеличить) |
| pg_ssl | false | признак использования протокола SSL при подключении к pgproto |
| repo | 'https://download.picodata.io' | репозиторий для установки пакетов, значение для ночных сборок: https://download.binary.picodata.io |
| retries_admin_sock | 1 | количество попыток ожидания запуска инстанса (увеличьте, если ваши инстансы долго запускаются) |
| rootless | false | установка кластера в [режиме с ограниченными полномочиями](rootless.md) |
| service_password | | пароль для сервисной учетной записи pico_service |
| systemd_params | | словарь с [настройками systemd служб](systemd.md) |
| timeout_admin_sock | 60 | время ожидания запуска инстанса в секундах (увеличьте, если ваши инстансы долго запускаются) |
| user | root | имя пользователя для файлов (этот пользователь уже должен быть создан на каждом сервере кластера) |

### Пути
| Имя | Значение по умолчанию | Описание |
| ---      | ---      | ---      |
| bin_dir | /usr/bin | путь до исполняемого файла `picodata` |
| conf_dir | /etc/picodata | размещение настроечных файлов |
| cert_dir | /etc/picodata | корневой путь для размещения сертификатов |
| crash_dump_fetch_dir | ./crash_dumps | размещение файлов с дампами на станции ansible при выполнении тега `crash_dump` |
| data_dir | /var/lib/picodata | размещение данных |
| dir_mode | 0755 | права, создаваемые на каталоги |
| log_dir | /var/log/picodata | размещение файлов логирования и аудита |
| report_dir | ../ | размещение файла с отчетом об установленных инстансах |
| run_dir | /var/run/picodata | размещение socket-файлов |
| share_dir | /usr/share/picodata | размещение служебных данных (плагинов) |
| supervisord_dir | /etc/picodata/supervisord | размещение кофигурационных файлов для supervisord |
| systemd_dir | /etc/systemd/system | размещение systemd-файлов |

### Логирование и аудит
| Имя | Значение по умолчанию | Описание |
| ---      | ---      | ---      |
| audit | true | аудит событий в кластере, при включении файлы будут размещаться в log_dir и начинаться с audit- |
| audit_pipe_command | | перенаправление вывода сообщений аудита в подпроцесс через pipe |
| audit_to | syslog | место хранения аудит-файлов. Возможные значения: syslog, file, pipe |
| log_format | plain | формат отладочного журнала (plain, json) |
| log_level | info | уровень логирования. Возможные значения: fatal, system, error, crit, warn, info, verbose, debug |
| log_pipe_command | | перенаправление вывода сообщений в подпроцесс через pipe |
| log_to | syslog | место хранения лог-файлов. Возможные значения: file, syslog, pipe |

### Адреса и порты
| Имя | Значение по умолчанию | Описание |
| ---      | ---      | ---      |
| first_bin_port | 13301 | начальный номер порта для бинарных портов инстансов кластера |
| first_http_port | 18001 | начальный номер порта для http-портов инстансов кластера |
| first_pg_port | 15001 | начальный номер порта для postgress-протокола инстансов кластера. Значение 0 выключает поддержку протокола postgress |
| listen_address | `{{ansible_fqdn}}` | Jinja шаблон для определения адреса сервера. Для IP можно указать {{ansible_default_ipv4.address}} |
| pg_address | `{{ansible_fqdn}}` | Jinja шаблон для определния адреса сервера для подключения по postgress-протоколу. Для IP можно указать {{ansible_default_ipv4.address}}. Обычно, совпадает с `listen_address`, используется, если вы хотите разнести внутренний и внешний траффик по разным сетевым интерфейсам |

## Бэкапы
| Имя | Значение по умолчанию | Описание |
| ---      | ---      | ---      |
| backup_dir | /var/lib/picodata/backups | каталог для размещения бэкапов локально |
| backup_fetch | false | необходимость скачивания бэкапов с серверов, если выставлена в false, то бэкапы сохраняются только локально на серверах. Используется также и при восстановлении |
| backup_fetch_dir | backups | каталог для размещения скачанных бэкапов на станции ansible с серверов кластера  |
| force_copy_backup | false | копировать бэкап со станции бэкапа даже, если он есть на удаленных серверах |
| restore_dir | | указание каталога для восстановления кластера в формате YYYYMMDDhhmmss, если не указан, то будет браться последний из существующих |
| ip_replacements_file | None | Путь к файлу со словарем замены старых ip-адресов на новые при восстановлении из резервной копии |


### Прочие
| Имя | Значение по умолчанию | Описание |
| ---      | ---      | ---      |
| cmdfile | | файл с командами, который используется при вызове с тэгом `command` |
| cmdline | | однострочная команда, которая используется при вызове с тэгом `command`. Можно использовать несколько команд через разделитель `\n` |
| debug | false | вывод отладочной информации |
| enable | true | используется только при тэге остановки кластера (`stop`) для того, чтобы инстансы не запустились при перезагрузки сервера |
| extra_vars | {} | словарь с дополнительными переменными окружения для всего кластера | выражения |
| fd_uniq_per_instance | false | позволяет разворачивать репликасет из нескольких реплик на одном сервере. Испольуется только для тестовых целей! |
| filter | .* | опциональный фильтр по именам инстансов, используется при вызове с тегами `command`, `restart`, `stop`, `start`. Можно использовать регулярные | instance | | имя инстанса, используется с тегом `rebootstrap` |
| need_restart | true | рестартовать инстансы кластера после изменения конфигурации |
| peer | | peer-адрес, используется с тегом `rebootstrap` |
| purge | true | при выставлении этой переменной в `false` при удалении кластера будт оставлены файлы с данными, конфигурационные файлы и лог-файлы |
| remove_pkg | false | при выставлении этой переменной в `true` при удалении кластера будет также удален пакет picodata с серверов |
| serial_host_restart | 100 | количество серверов для одновременного рестарта |
| shredding | false | режим безопасного удаления рабочих файлов инстанса путем многократной перезаписи специальными битовыми последовательностями |
| sigkill | false | принудительно отправить сигнал SIGKILL во все процессы picodata (помогает остановить кластер, если он сломался по какой-либо причине) |
| sql_file | | файл с набором команд для выполнения после деплоя кластера |
| remove_sharedir | true | удалять share_dir при удалении кластера |
---

## Переменные для тиров (tiers)
| Имя | Значение по умолчанию | Описание |
| ---      | ---      | ---      |
| bucket_count | 30000 | количество бакетов в тире |
| can_vote | true | возможность инстансов участвовать в голосовании на выборах raft-лидера |
| config | | словарь для настройки инстансов тира, например указание размера инстанса. Подробнее в [документации параметр instance](https://docs.picodata.io/picodata/24.4/reference/config/)
| db_config | {} | словарь с [параметрами конфигурации кластера](https://docs.picodata.io/picodata/stable/reference/db_config/) для тира |
| extra_vars | {} | словарь с дополнительными переменными окружения для конкретного тира |
| instances_per_server | 1 | количество инстансов тира на каждом сервере - если указано, то преобладает над `replicaset_count`, если не указано, то рассчитается автоматически |
| replicaset_count | 1 | количество репликасетов в тире |
| replication_factor | 1 | фактор репликации |
| systemd_params | {} | словарь с [настройками systemd служб](systemd.md) |

В переменных `extra_vars` можно использовать литерал `<INSTANCE_NUM>` для подстановки номера инстанса на сервере в значение переменной, пример:
```yaml
tiers:
  default:
    replicaset_count: 2
    replication_factor: 3
    bucket_count: 16384
    extra_vars:
      RADIX_ADDR: '0.0.0.0:73<INSTANCE_NUM>'
```

В таком случае для первого инстанса переменная `RADIX_ADDR` установит значение `0.0.0.0:7300`, для второго `0.0.0.0:7301`, для третьего `0.0.0.0:7302` и т.д.

### Размещение тиров по хостам (host_groups)

Групп хостов может быть несколько
```
host_groups:
- STORAGES
```
Если host_groups не определена, то инстансы будут раскатаны на каждом сервере.

Переменная host_group должна быть определена в списке серверов.

---

## Переменные для хостов

Пример настройки хостов
```
GROUP1:                             # Группа серверов
  hosts:
    server-1-1:                     # Имя сервера 1
      ansible_host: 192.168.19.21   # адрес сервера 1
      host_group: 'ROUTERS'         # группа хостов

GROUP2:                             # Группа серверов
  hosts:
    server-2-1:                     # Имя сервера 2
      ansible_host: 192.168.19.22   # адрес сервера 2
      host_group: 'STORAGES'        # группа хостов

GROUP3:                             # Группа серверов
  hosts:
    server-3-1:                     # Имя сервера 3
      ansible_host: 192.168.19.23   # адрес сервера 3
      host_group: 'STORAGES'        # группа хостов
```

## Переменные для плагинов (plugins)

| Имя | Значение по умолчанию | Описание |
| ---      | ---      | ---      |
| config |  | месторасположение конфигурационного файла плагина на локальном хосте (опционально) |
| enable | true | выполнить все sql-инструкции по настройке плагина, кроме его включения (ранее была `do_not_enable_plugin`) |
| install_sql | true | выполнить sql-инструкции по настройке и включению плагина (используется для отладки, ранее была `do_not_run_plugin_install_sql`) |
| migration_context | | переменные для подстановки в миграциях (опционально) |
| migration_timeout | 300 | время ожидания окончания выполнения миграций |
| path |  | месторасположение пакета с плагином на локальном хосте |
| plugin_timeout | 300 | время ожидания окончания выполнения команд установки плагина |
| services | | словарь с настройками для служб плагина (пока поддерживаются только тиры) |

Пример настройки плагина
```yaml
plugins:
  example:
    path: '../files/weather-cache_0.1.0-ubuntu-focal.tar.gz'
    config: '../files/weather-config.yml'
    services:
      weather_service:
        tiers:
          - default
    migration_context:
      red_tier: 'my_tier'
    migration_timeout: 600
    plugin_timeout: 900
```
